                                                                                                                                                                                                                                                                                                                                                                                                                                                                  install.sh
#!/usr/bin/env bash
set -euo pipefail

INSTALL_PREFIX="/usr/local"
SUPPORTED_VERSIONS=("3.8" "3.9" "3.10" "3.11" "3.12")

log() { echo "[INFO] $1"; }
warn() { echo "[WARN] $1"; }
fail() { echo "[ERROR] $1"; exit 1; }

# OS check
[ -f /etc/os-release ] || fail "Cannot detect OS"
. /etc/os-release
[ "$ID" = "ubuntu" ] || fail "Only Ubuntu supported"

# Show installed Pythons
echo "Installed Python versions:"
ls /usr/bin/python* /usr/local/bin/python* 2>/dev/null | grep -E 'python[0-9]+\.[0-9]+' || echo "None"
echo

# Select version
echo "Supported versions:"
for v in "${SUPPORTED_VERSIONS[@]}"; do echo " - $v"; done
echo

read -r -p "Enter Python version (e.g. 3.10): " PYTHON_VERSION
[[ " ${SUPPORTED_VERSIONS[*]} " =~ " ${PYTHON_VERSION} " ]] || fail "Unsupported version"

# Select method
read -r -p "Install method (package/tarball) [package]: " METHOD
INSTALL_METHOD="${METHOD:-package}"

# Check existing installation
UPGRADE=false
if command -v python${PYTHON_VERSION} >/dev/null 2>&1; then
    INSTALLED_VERSION=$(python${PYTHON_VERSION} --version | awk '{print $2}')
    log "Python ${PYTHON_VERSION} already installed (version: ${INSTALLED_VERSION})"

    read -r -p "Do you want to upgrade/reinstall Python ${PYTHON_VERSION}? (y/n): " CHOICE
    if [ "$CHOICE" = "y" ]; then
        UPGRADE=true
        log "Upgrade selected"
    else
        log "Skipping installation"
        exit 0
    fi
fi

apt_available() {
    apt-cache show python${PYTHON_VERSION} >/dev/null 2>&1
}

install_tarball() {
    log "Installing Python ${PYTHON_VERSION} from source"

    sudo apt update -qq
    sudo apt install -y build-essential libssl-dev zlib1g-dev \
        libbz2-dev libreadline-dev libsqlite3-dev libffi-dev \
        libncursesw5-dev xz-utils tk-dev wget

    case "$PYTHON_VERSION" in
        3.8) FULL="3.8.19" ;;
        3.9) FULL="3.9.19" ;;
        3.10) FULL="3.10.14" ;;
        3.11) FULL="3.11.8" ;;
        3.12) FULL="3.12.3" ;;
        *) fail "Invalid version" ;;
    esac

    cd /tmp
    rm -rf Python-${FULL}*
    wget -q https://www.python.org/ftp/python/${FULL}/Python-${FULL}.tgz
    tar -xzf Python-${FULL}.tgz
    cd Python-${FULL}

    ./configure --enable-optimizations --prefix=${INSTALL_PREFIX}
    make -j"$(nproc)"
    sudo make altinstall
}

# Install / Upgrade
if [ "$INSTALL_METHOD" = "package" ]; then
    log "Using package manager"

    sudo apt update -qq
    if apt_available; then
        if [ "$UPGRADE" = true ]; then
            sudo apt install -y --reinstall python${PYTHON_VERSION} \
                python${PYTHON_VERSION}-venv python${PYTHON_VERSION}-dev
        else
            sudo apt install -y python${PYTHON_VERSION} \
                python${PYTHON_VERSION}-venv python${PYTHON_VERSION}-dev
        fi
    else
        warn "Not available via apt, switching to tarball"
        install_tarball
    fi
else
    install_tarball
fi

# Validation
echo
python${PYTHON_VERSION} --version
which python${PYTHON_VERSION}

log "Done"

