#!/bin/bash
# Exit immediately if any command fails
set -e

# ------------------------------------
# Generic Python Installation Script
# ------------------------------------

echo "======================================"
echo " Generic Python Installer Started"
echo "======================================"

# ------------------------------------
# Load configuration
# ------------------------------------
if [ -f config.env ]; then
    echo "Loading configuration from config.env..."
    source config.env
else
    echo "ERROR: config.env file not found!"
    exit 1
fi

# ------------------------------------
# Validate inputs
# ------------------------------------
if [ -z "$PYTHON_VERSION" ]; then
    echo "ERROR: PYTHON_VERSION is not set"
    exit 1
fi

if [ -z "$INSTALL_METHOD" ]; then
    echo "ERROR: INSTALL_METHOD is not set"
    exit 1
fi

echo "Python Version  : $PYTHON_VERSION"
echo "Install Method  : $INSTALL_METHOD"

# ------------------------------------
# Detect package manager
# ------------------------------------
if command -v apt >/dev/null 2>&1; then
    PKG_MANAGER="apt"
elif command -v yum >/dev/null 2>&1; then
    PKG_MANAGER="yum"
else
    echo "ERROR: Supported package manager not found (apt/yum)"
    exit 1
fi

echo "Detected Package Manager: $PKG_MANAGER"

# ------------------------------------
# Check existing Python
# ------------------------------------
check_existing_python() {
    if command -v python${PYTHON_VERSION} >/dev/null 2>&1; then
        echo "Python ${PYTHON_VERSION} already installed."
        python${PYTHON_VERSION} --version
        echo "Skipping installation."
        exit 0
    fi
}

# ------------------------------------
# Install dependencies (tarball)
# ------------------------------------
install_dependencies() {
    echo "Installing build dependencies..."

    if [ "$PKG_MANAGER" == "apt" ]; then
        sudo apt update
        sudo apt install -y \
            build-essential \
            libssl-dev \
            zlib1g-dev \
            libffi-dev \
            libbz2-dev \
            libreadline-dev \
            libsqlite3-dev \
            wget
    else
        sudo yum groupinstall -y "Development Tools"
        sudo yum install -y \
            openssl-devel \
            bzip2-devel \
            libffi-devel \
            wget
    fi
}

# ------------------------------------
# Package manager installation
# ------------------------------------
install_python_package() {
    echo "Installing Python ${PYTHON_VERSION} using package manager..."

    if [ "$PKG_MANAGER" == "apt" ]; then
        sudo apt update
        sudo apt install -y python${PYTHON_VERSION}
    else
        sudo yum install -y python${PYTHON_VERSION}
    fi
}

# ------------------------------------
# Tarball installation
# ------------------------------------
install_python_tarball() {
    VERSION_FULL="$PYTHON_VERSION"
    URL="https://www.python.org/ftp/python/${VERSION_FULL}/Python-${VERSION_FULL}.tgz"

    echo "Downloading Python ${VERSION_FULL} source..."
    wget -q $URL

    tar -xzf Python-${VERSION_FULL}.tgz
    cd Python-${VERSION_FULL}

    echo "Configuring build..."
    ./configure --enable-optimizations

    echo "Compiling Python..."
    make -j$(nproc)

    echo "Installing Python (altinstall)..."
    sudo make altinstall

    cd ..
}

# ------------------------------------
# Main execution
# ------------------------------------
check_existing_python

if [ "$INSTALL_METHOD" == "package" ]; then
    install_python_package
elif [ "$INSTALL_METHOD" == "tarball" ]; then
    install_dependencies
    install_python_tarball
else
    echo "ERROR: Invalid INSTALL_METHOD. Use package or tarball."
    exit 1
fi

# ------------------------------------
# Validation
# ------------------------------------
echo "Verifying installation..."
python${PYTHON_VERSION} --version

echo "======================================"
echo " Python Installation Completed"
echo "======================================"
