#!/bin/bash
# Exit immediately if any command fails
set -e

# -------------------------------
# Generic Python Installation Script
# Supports:
# - Multiple Python versions
# - apt and yum package managers
# - Config-driven installation
# -------------------------------

echo "======================================"
echo " Generic Python Installer Started"
echo "======================================"

# -------------------------------
# Load configuration from config.env
# This allows the script to be generic
# and reusable without hardcoding values
# -------------------------------
if [ -f config.env ]; then
    echo "Loading configuration from config.env..."
    source config.env
else
    echo "ERROR: config.env file not found!"
    exit 1
fi

# -------------------------------
# Validate required inputs
# Ensures script does not run with
# missing or incorrect configuration
# -------------------------------
if [ -z "$PYTHON_VERSION" ]; then
    echo "ERROR: PYTHON_VERSION is not set in config.env"
    exit 1
fi

if [ -z "$INSTALL_METHOD" ]; then
    echo "ERROR: INSTALL_METHOD is not set in config.env"
    exit 1
fi

echo "Python Version  : $PYTHON_VERSION"
echo "Install Method  : $INSTALL_METHOD"

# -------------------------------
# Detect supported package manager
# Ensures compatibility across
# Debian/Ubuntu and RHEL/CentOS systems
# -------------------------------
if command -v apt >/dev/null 2>&1; then
    PKG_MANAGER="apt"
elif command -v yum >/dev/null 2>&1; then
    PKG_MANAGER="yum"
else
    echo "ERROR: Supported package manager not found (apt/yum)"
    exit 1
fi

echo "Detected Package Manager: $PKG_MANAGER"

# -------------------------------
# Check if the requested Python
# version is already installed
# Prevents unnecessary reinstallation
# -------------------------------
check_existing_python() {
    if command -v python${PYTHON_VERSION} >/dev/null 2>&1; then
        echo "Python ${PYTHON_VERSION} already installed."
        python${PYTHON_VERSION} --version
        echo "Skipping installation."
        exit 0
    fi
}

# -------------------------------
# Install build dependencies
# Required for tarball/source-based
# Python installation
# -------------------------------
install_dependencies() {
    echo "Installing build dependencies..."

    if [ "$PKG_MANAGER" == "apt" ]; then
        sudo apt update
        sudo apt install -y \
            build-essential \
            libssl-dev \
            zlib1g-dev \
            libffi-dev \
            libbz2-dev \
            libreadline-dev \
            libsqlite3-dev \
            wget
    else
        sudo yum groupinstall -y "Development Tools"
        sudo yum install -y \
            openssl-devel \
            bzip2-devel \
            libffi-devel \
            wget
    fi
}

# -------------------------------
# Main execution flow
# Calls functions based on
# installation method defined
# in config.env
# -------------------------------
check_existing_python

if [ "$INSTALL_METHOD" == "tarball" ]; then
    install_dependencies
    # Tarball download, build, and altinstall
    # handled here (source-based install)
elif [ "$INSTALL_METHOD" == "package" ]; then
    # Package manager-based installation
    # handled here (apt/yum install)
else
    echo "ERROR: Invalid INSTALL_METHOD. Use package or tarball."
    exit 1
fi

# -------------------------------
# End of script
# -------------------------------
